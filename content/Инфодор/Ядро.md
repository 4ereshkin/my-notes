# Codex проекта `clouds_pipeline`

## Общая архитектура

Проект состоит из трёх ключевых компонентов:

- **Сервис**: принимает внешние пользовательские запросы, исполняет инструкции, возвращает результат.
- **Ядро**: внутренний движок, реализующий графовую модель инструкций, их валидацию, компиляцию и исполнение.
- **Лаборатория**: визуальный редактор для конструирования графов (инструкций) через ноды. Использует `Dear PyGui`.

## Концепции

- **Нода (`Node`)** — абстракция метода. Содержит: `id`, `label`, `type`, `params`, `inputs`, `outputs`.
- **Инструкция** — граф (`Graph`) из нод и их связей (`edges`), реализующий определённую цель.
- **Каталог (`REGISTRY`)** — набор спецификаций нод (`NodeSpec`), которые служат шаблонами.

## Классы Ядра

### `Node`

```python
@dataclass(frozen=True)
class Node:
    id: str
    label: str
    type: str
    params: Dict[str, Any] = field(default_factory=dict)
    inputs: List[str] = field(default_factory=list)
    outputs: List[str] = field(default_factory=list)
```

Метод `with_params(...)` возвращает обновлённую копию с новыми параметрами.

### `Graph`

Граф из нод и рёбер.

```python
@dataclass
class Graph:
    nodes: Dict[str, Node] = field(default_factory=dict)
    edges: List[Tuple[str, str]] = field(default_factory=list)
```

Методы:
- `add_node(node)` — добавляет ноду
- `add_edge(src, dst)` — соединяет ноды
- `successors(node_id)` и `predecessors(node_id)` — возвращают соседей

### `Validator` и `GraphValidator`

Абстрактный класс и реализация, проверяющая корректность графа.

Проверки:
- `_check_empty()` — отсутствие нод/рёбер
- `_check_self_loops()` — самосвязи
- `_check_cycles_with_path()` — циклы (DFS с восстановлением пути)
- `_check_minimal_structure()` — наличие хотя бы одного reader и writer
- `_check_params()` — обязательные и лишние параметры
- `_check_ports()` — корректность входов/выходов и их наличие

### `Compiler`, `Executor`

Компилятор преобразует `Graph` в инструкцию (`pipeline`) для PDAL.
Исполнитель запускает процесс и возвращает результат.

## Каталог методов

`NodeSpec` описывает типы операций:

```python
@dataclass(frozen=True)
class NodeSpec:
    type: str
    title: str
    category: str
    inputs: List[PortSpec]
    outputs: List[PortSpec]
    params: List[ParamSpec]
```

Дополнительно доступны хуки: `compile` и `validate_params`.

## Принципы

- Все изменения с нодами — иммутабельные.
- Валидация отделена от исполнения.
- Каталог служит единственным источником правды о методах.
- Поддержка генерации UI из `NodeSpec`.

## Использование

1. Конструируется `Graph` из `Node`
2. Валидируется через `GraphValidator`
3. Компилируется в PDAL-инструкцию
4. Исполняется
5. Результат возвращается

## Репозиторий

- GitHub: `4ereshkin/clouds_pipeline`
- В `.gitignore` добавлены директории с данными и тяжёлые артефакты



