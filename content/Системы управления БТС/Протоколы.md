## Протоколы

### Введение

При передаче данных абсолютно всегда, где бы мы ни были, будут протоколы, регламентирующие процесс передачи.
___
## CAN шина

CAN (сеть контроллеров) - двухпроводной многоадресный последовательный протокол связи, широко используемый в автомобильной промышленности и других приложениях реального времени. Он разработан для обеспечения связи между микроконтроллерами и устройствами в пределах системы без использования центрального компьютера.

### История
CAN изобрели в BOSH в 1980-х для решения проблемы сложной проводки. Традиционная проводка значительно увеличивала вес авто, стоимость и сложность конструкции, особенно с ростом количества электронных систем. Протокол же позволяет устройствам (ECU - электронным блокам управления) обмениваться данными по единой шине, сокращая количество проводов и упрощая систему.

Благодаря надёжности, гибкости и экономичности CAN стал стандартом де-факто в автомобильной промышленности и нашёл применение в различных областях, включая промышленную автоматизацию, медицинское оборудование и транспорт.

### Основные характеристики
Это промышленный стандарт. CAN помогает объединить в одну сеть узлы, агрегаты, датчики и т.п. Протокол широковещательный, это значит, что все устройства CAN-сети принимают все передаваемые по шине сигналы. Режим передачи данных последователем, при этом байты сообщений формируют кадры определённого вида.

- Каждое сообщение имеет свой приоритет.
- Есть механизм ловли ошибок.
- Возможность присутствия несколько master устройств в одной сети.
- Широкий диапазон скоростей работы.
- Устойчивость интерфейса к помехам.
- Есть механизм обнаружения "сбойных узлов" в сет.

Любой узел (node) на шине может передавать данные, при этом существует арбитраж на основе приоритетов.

### Арбитраж приоритетов

#### CSMA
CSMA (множественный доступ с контролем несущей) - каждый узел слушает шину, прежде чем начать передачу.

#### CD
CD (обнаружение коллизий) - если два узла начинают передавать данные одновременно, они обнаруживают коллизию, т.е. конфликт.

#### Ориентация на сообщения
CAN передаёт сообщения (messages), а не адреса отдельных узлов. Каждый узел выбирает, какие сообщения ему нужны, на основе ID сообщения.

#### Механизм арбитража
В случае коллизии узлы сравнивают приоритеты  своих сообщений (чем ниже ID, тем выше приоритет). Узел с более низким приоритетом прекращает передачу, а узел с более высоким приоритетом продолжает. Это гарантирует, что сообщение с наивысшим приоритетом будет передано первым.

#### Неразрушающий арбитраж
Арбитраж происходит без прерывания процесса передачи данных. Узел, проигравший в арбитраже, не повреждает данные, которые уже были переданы.

### Доминантные и рецессивные биты

Важнейшим свойством CAN является то, что если один из узлов сети хочет выставить на линии рецессивный бит, а другой доминантный, то в итоге на линии окажется именно доминантный.

### Условие работы

Важным условием работоспособности шины является наличие на концах витой пары согласующих резисторов, которые также называют терминаторами, с сопротивлением около 120 Ом. Сигналы, передаются по витой паре, получили название CAN_H и CAN_L (High и Low).

___
## Кадры

### Введение

Протокол CAN определяет 4 вида кадров, состоящих из объединения битов.

- Кадр данных (data frame);
- Кадр удалённого запроса (remote frame);
- Кадр перегрузки (overload frame);
- Кадр ошибки (error frame).

Для кадра данных возможны два варианта - базовый формат и расширенный.

### Remote frame

Представляет из себя кадр данных без поля данных  с рецессивным битом RTR. Он используется в случае, когда один узел хочет запросить данные у другого узла.

### Error frame

Передаёт устройство, обнаружившее ошибку в сети. Фрейм ошибки имеет наивысший приоритет и принимается всеми устройствами сети в обязательном порядке.

### Overload frame

Используется очень редко. Его идея и назначение заключается в устройстве, которые в данный момент не может принять данные. В таком случае, устройство просит повторить передачу тех данных, которые просто не успела в себя вместить.

## Уровни

### Физический уровень

Физический уровень CAN характеризуется терминами типо двухуровневой шины, дифференциальной передачи, терминирующих резисторах, скорости передачи данных.



___
